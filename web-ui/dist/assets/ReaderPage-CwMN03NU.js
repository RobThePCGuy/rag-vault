import{a as o,b as st,j as e}from"./query-DPt-uCb6.js";import{useReaderSettings as we}from"./ReaderSettingsContext-CkSjqsRh.js";import{g as nt,u as Ne,a as rt,b as at,s as ot,S as q,c as lt,K as ct,d as Ce,e as it,f as dt}from"./index-D068MV_o.js";import{m as R,A}from"./motion-CKwJwI3J.js";import{c as ut,u as xt}from"./vendor-C2QPsZ3S.js";function ht(t="100px"){const[s,n]=o.useState(new Set),[r,a]=o.useState(null),i=o.useRef(null),u=o.useRef(new Map),d=o.useRef(new Set);o.useEffect(()=>{i.current=new IntersectionObserver(c=>{n(f=>{const m=new Set(f);for(const g of c){const y=Number(g.target.getAttribute("data-chunk-index"));Number.isNaN(y)||(g.isIntersecting?m.add(y):m.delete(y))}return m})},{rootMargin:t,threshold:[0,.25,.5,.75,1]});const x=i.current;for(const[,c]of u.current)x.observe(c);for(const c of d.current){const f=u.current.get(c);f&&x.observe(f)}return d.current.clear(),()=>{x.disconnect(),i.current=null}},[t]),o.useEffect(()=>{if(s.size===0)a(null);else{const x=Array.from(s).sort((c,f)=>c-f);a(x[0]??null)}},[s]);const l=o.useCallback((x,c)=>{const f=i.current,m=u.current.get(x);m&&f&&f.unobserve(m),d.current.delete(x),c?(u.current.set(x,c),c.setAttribute("data-chunk-index",String(x)),f?f.observe(c):d.current.add(x)):u.current.delete(x)},[]);return{visibleChunkIndices:s,registerChunk:l,activeChunkIndex:r}}function ft(t,s,n=300,r=5){const[a,i]=o.useState([]);o.useEffect(()=>{if(!t||s.size===0){i([]);return}const x=Array.from(s).map(f=>({filePath:t,chunkIndex:f})),c=setTimeout(()=>{i(x)},n);return()=>clearTimeout(c)},[t,s,n]);const{data:u={},isLoading:d,error:l}=st({queryKey:["batchRelatedChunks",a,r],queryFn:()=>a.length>0?nt(a,r):{},enabled:a.length>0,staleTime:300*1e3});return{relatedChunks:u,isLoading:d,error:l}}function ie(){return crypto.randomUUID()}function mt(t,s){const n=t||"1",r=String.fromCharCode(97+s);return`${n}${r}`}function pt(t){if(t.length===0)return null;const s=t[0];if(!s)return null;const n={id:ie(),chunkKey:s.chunkKey,visitedAt:s.visitedAt,connectionReason:s.connectionReason,branchLabel:"1",children:[]};let r=n;for(let a=1;a<t.length;a++){const i=t[a];if(!i)continue;const u={id:ie(),chunkKey:i.chunkKey,visitedAt:i.visitedAt,connectionReason:i.connectionReason,branchLabel:String(a+1),children:[]};r.children.push(u),r=u}return n}function Ie(t,s=[]){return t&&(s.push({chunkKey:t.chunkKey,visitedAt:t.visitedAt,connectionReason:t.connectionReason}),t.children.length>0&&Ie(t.children[0]||null,s)),s}function Se(t,s){if(!t)return null;if(t.id===s)return t;for(const n of t.children){const r=Se(n,s);if(r)return r}return null}function bt(){const t=Ne(),[s,n]=o.useState(null),r=o.useCallback((l,x)=>{t.addToTrail(l,x)},[t]),a=o.useCallback(()=>t.currentTrail?t.currentTrail.root?t.currentTrail.root:pt(t.currentTrail.steps):null,[t.currentTrail]),i=o.useCallback(()=>Ie(a()),[a]),u=o.useCallback((l,x)=>{if(!t.currentTrail)return null;const c=a();if(!c)return null;const f=s||c.id,m=Se(c,f);if(!m)return null;const g={id:ie(),chunkKey:l,visitedAt:new Date().toISOString(),connectionReason:x,branchLabel:mt(m.branchLabel,m.children.length),children:[]};return m.children.push(g),n(g.id),g.id},[t.currentTrail,s,a]),d=o.useMemo(()=>{if(!t.currentTrail)return 0;const l=a();if(!l)return t.currentTrail.steps.length;let x=0;const c=f=>{x++,f.children.forEach(c)};return c(l),x},[t.currentTrail,a]);return{currentTrail:t.currentTrail,savedTrails:t.trails,isRecording:t.currentTrail!==null,stepCount:d,startNewTrail:t.startNewTrail,addStep:r,saveTrail:t.saveTrail,loadTrail:t.loadTrail,deleteTrail:t.deleteTrail,clearCurrentTrail:t.clearCurrentTrail,currentNodeId:s,setCurrentNodeId:n,addBranch:u,getTrailTree:a,flattenTrail:i}}function gt({totalChunks:t,activeChunkIndex:s,onNavigateToChunk:n,onToggleSplit:r,onPinTopSuggestion:a,onOpenSearch:i,onOpenHelp:u,onCloseOverlay:d,isOverlayOpen:l,enabled:x=!0,isSearchOpen:c=!1,onNextSearchMatch:f,onPreviousSearchMatch:m,onToggleBookmark:g,onOpenTagPicker:y,onToggleAnnotationPanel:h,onToggleReadingMode:b,onOpenComparison:v,onResetGraphLayout:w,onOpenGraphExport:k,onTogglePathfinding:S,onToggleClustering:E,isGraphOpen:K=!1,onToggleInferredLinks:H,onToggleCrossDocPanel:B,onToggleStatsPanel:W,onToggleDiscoveryMode:T,isDiscoveryMode:N=!1,onDiscoverySelectSuggestion:D,onDiscoveryGoBack:p}){const O=o.useRef(null),F=o.useRef({totalChunks:t,activeChunkIndex:s,isOverlayOpen:l,isSearchOpen:c,isGraphOpen:K,isDiscoveryMode:N}),C=o.useRef({onNavigateToChunk:n,onToggleSplit:r,onPinTopSuggestion:a,onOpenSearch:i,onOpenHelp:u,onCloseOverlay:d,onNextSearchMatch:f,onPreviousSearchMatch:m,onToggleBookmark:g,onOpenTagPicker:y,onToggleAnnotationPanel:h,onToggleReadingMode:b,onOpenComparison:v,onResetGraphLayout:w,onOpenGraphExport:k,onTogglePathfinding:S,onToggleClustering:E,onToggleInferredLinks:H,onToggleCrossDocPanel:B,onToggleStatsPanel:W,onToggleDiscoveryMode:T,onDiscoverySelectSuggestion:D,onDiscoveryGoBack:p});F.current={totalChunks:t,activeChunkIndex:s,isOverlayOpen:l,isSearchOpen:c,isGraphOpen:K,isDiscoveryMode:N},C.current={onNavigateToChunk:n,onToggleSplit:r,onPinTopSuggestion:a,onOpenSearch:i,onOpenHelp:u,onCloseOverlay:d,onNextSearchMatch:f,onPreviousSearchMatch:m,onToggleBookmark:g,onOpenTagPicker:y,onToggleAnnotationPanel:h,onToggleReadingMode:b,onOpenComparison:v,onResetGraphLayout:w,onOpenGraphExport:k,onTogglePathfinding:S,onToggleClustering:E,onToggleInferredLinks:H,onToggleCrossDocPanel:B,onToggleStatsPanel:W,onToggleDiscoveryMode:T,onDiscoverySelectSuggestion:D,onDiscoveryGoBack:p};const z=o.useCallback(()=>{const I=document.activeElement;if(I){const L=I.tagName.toLowerCase();if(L==="input"||L==="textarea"||I.getAttribute("contenteditable")==="true")return!0}const $=window.getSelection();return!!($&&$.toString().length>0)},[]),U=o.useCallback(I=>{if(z())return;const $=F.current,L=C.current;if(I.key==="Escape"){$.isOverlayOpen&&(I.preventDefault(),L.onCloseOverlay());return}if($.isSearchOpen){switch(I.key){case"n":I.preventDefault(),L.onNextSearchMatch?.();return;case"N":I.preventDefault(),L.onPreviousSearchMatch?.();return}return}if(!$.isOverlayOpen)switch(I.key){case"j":{I.preventDefault();const _=$.activeChunkIndex===null?0:Math.min($.activeChunkIndex+1,$.totalChunks-1);L.onNavigateToChunk(_);break}case"k":{I.preventDefault();const _=$.activeChunkIndex===null?0:Math.max($.activeChunkIndex-1,0);L.onNavigateToChunk(_);break}case" ":{I.preventDefault(),L.onToggleSplit();break}case"p":{I.preventDefault(),L.onPinTopSuggestion();break}case"/":{I.preventDefault(),L.onOpenSearch();break}case"?":{I.preventDefault(),L.onOpenHelp();break}case"b":{I.preventDefault(),L.onToggleBookmark?.();break}case"t":{I.preventDefault(),L.onOpenTagPicker?.();break}case"a":{I.preventDefault(),L.onToggleAnnotationPanel?.();break}case"m":{I.preventDefault(),L.onToggleReadingMode?.();break}case"c":{I.preventDefault(),L.onOpenComparison?.();break}case"r":{$.isGraphOpen&&(I.preventDefault(),L.onResetGraphLayout?.());break}case"e":{$.isGraphOpen&&(I.preventDefault(),L.onOpenGraphExport?.());break}case"f":{$.isGraphOpen&&(I.preventDefault(),L.onTogglePathfinding?.());break}case"g":{$.isGraphOpen&&(I.preventDefault(),L.onToggleClustering?.());break}case"i":{I.preventDefault(),L.onToggleInferredLinks?.();break}case"x":{I.preventDefault(),L.onToggleCrossDocPanel?.();break}case"s":{I.preventDefault(),L.onToggleStatsPanel?.();break}case"d":{I.preventDefault(),L.onToggleDiscoveryMode?.();break}case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":{if($.isDiscoveryMode){I.preventDefault();const _=parseInt(I.key,10)-1;L.onDiscoverySelectSuggestion?.(_)}break}case"Backspace":{$.isDiscoveryMode&&(I.preventDefault(),L.onDiscoveryGoBack?.());break}}},[z]);return o.useEffect(()=>{if(x)return document.addEventListener("keydown",U),()=>{document.removeEventListener("keydown",U)}},[x,U]),{containerRef:O}}async function vt(t){const n=new TextEncoder().encode(t.slice(0,500)),r=await crypto.subtle.digest("SHA-256",n);return Array.from(new Uint8Array(r)).slice(0,8).map(i=>i.toString(16).padStart(2,"0")).join("")}function yt({filePath:t,chunks:s,activeChunkIndex:n,vaultId:r="default",debounceMs:a=1e3}){const i=`rag-vault-reading-progress-${r}`,[u,d]=rt(i,{}),l=o.useRef(null),x=o.useRef(null),c=o.useRef(!1),f=o.useRef({chunkIndex:0,scrollOffset:0});o.useEffect(()=>{if(s.length>0){const w=s[0];w&&vt(w.text).then(k=>{x.current=k})}},[s]);const m=o.useCallback(w=>`${t}:${w}`,[t]),g=Object.entries(u).find(([w])=>w.startsWith(`${t}:`)),y=!!g,h=g?g[1].lastChunkIndex:null,b=o.useCallback((w,k)=>{x.current&&(f.current={chunkIndex:w,scrollOffset:k},l.current&&clearTimeout(l.current),l.current=setTimeout(()=>{const S=x.current;if(!S)return;const{chunkIndex:E,scrollOffset:K}=f.current,H=m(S);d(B=>({...B,[H]:{lastChunkIndex:E,scrollOffsetWithinChunk:K,lastVisited:new Date().toISOString(),fileFingerprint:S}}))},a))},[m,d,a]);o.useEffect(()=>{if(n!==null&&c.current){const w=document.getElementById(`chunk-${n}`),k=w?w.getBoundingClientRect().top:0;b(n,k)}},[n,b]);const v=o.useCallback(()=>{if(!x.current||s.length===0)return null;const w=x.current,k=m(w),S=u[k];return S?S.fileFingerprint!==w?(c.current=!0,{chunkIndex:0,scrollOffset:0}):(c.current=!0,{chunkIndex:Math.min(S.lastChunkIndex,s.length-1),scrollOffset:S.scrollOffsetWithinChunk}):Object.entries(u).find(([K])=>K.startsWith(`${t}:`))?(c.current=!0,{chunkIndex:0,scrollOffset:0}):(c.current=!0,null)},[t,s,u,m]);return o.useEffect(()=>()=>{l.current&&clearTimeout(l.current)},[]),{restorePosition:v,savePosition:b,hasSavedPosition:y,savedChunkIndex:h}}function kt(t){const s=at(),n=o.useMemo(()=>t?s.getHighlightsForChunk(t):[],[s,t]),r=o.useMemo(()=>{const c=new Map;for(const f of n){const m=s.getAnnotationForHighlight(f.id);m&&c.set(f.id,m)}return c},[n,s]),a=o.useCallback((c,f,m,g,y)=>{if(!t)throw new Error("No chunk key provided");return s.createHighlight(t,c,f,m,g,y)},[s,t]),i=o.useCallback(c=>{s.deleteHighlight(c)},[s]),u=o.useCallback((c,f)=>{s.updateHighlightColor(c,f)},[s]),d=o.useCallback((c,f)=>s.createAnnotation(c,f),[s]),l=o.useCallback((c,f)=>{s.updateAnnotation(c,f)},[s]),x=o.useCallback(c=>{s.deleteAnnotation(c)},[s]);return{highlights:n,annotations:r,createHighlight:a,deleteHighlight:i,updateHighlightColor:u,addNote:d,updateNote:l,deleteNote:x,hasHighlights:n.length>0}}function jt(t,s,n){const r=t.getRangeAt(0),a=[],i=document.createTreeWalker(s,NodeFilter.SHOW_TEXT);let u=i.nextNode();for(;u!==null;)a.push(u),u=i.nextNode();let d=0,l=!1;for(const f of a){if(f===r.startContainer){d+=r.startOffset,l=!0;break}d+=f.textContent?.length??0}if(!l)return null;let x=0,c=!1;for(const f of a){if(f===r.endContainer){x+=r.endOffset,c=!0;break}x+=f.textContent?.length??0}return!c||d<0||x>n.length||d>=x?null:{startOffset:d,endOffset:x}}function wt({containerRef:t,chunkText:s,enabled:n=!0}){const[r,a]=o.useState(null),i=o.useCallback(()=>{a(null),window.getSelection()?.removeAllRanges()},[]);return o.useEffect(()=>{if(!n)return;const u=()=>{const x=window.getSelection();if(!x||x.isCollapsed||!x.rangeCount){a(null);return}const c=t.current;if(!c){a(null);return}const f=x.getRangeAt(0);if(!c.contains(f.commonAncestorContainer)){a(null);return}const m=x.toString().trim();if(!m){a(null);return}const g=jt(x,c,s);if(!g){a(null);return}const y=f.getBoundingClientRect(),h=s.slice(Math.max(0,g.startOffset-30),g.startOffset),b=s.slice(g.endOffset,g.endOffset+30);a({startOffset:g.startOffset,endOffset:g.endOffset,text:m,contextBefore:h,contextAfter:b,rect:y})};let d;const l=()=>{clearTimeout(d),d=setTimeout(u,100)};return document.addEventListener("selectionchange",l),()=>{document.removeEventListener("selectionchange",l),clearTimeout(d)}},[n,t,s]),{selection:r,clearSelection:i}}function Nt(t){return t.map(s=>({chunkIndex:s.chunkIndex,text:s.text,lowerText:s.text.toLowerCase()}))}function be(t,s,n){if(!s||s.length===0)return[];const r=[],a=n?s:s.toLowerCase();for(const i of t){const u=n?i.text:i.lowerText;let d=0;for(;d<u.length;){const l=u.indexOf(a,d);if(l===-1)break;const x=Math.max(0,l-25),c=Math.min(i.text.length,l+s.length+25),f=i.text.slice(x,c);r.push({chunkIndex:i.chunkIndex,startOffset:l,endOffset:l+s.length,context:(x>0?"...":"")+f+(c<i.text.length?"...":"")}),d=l+1}}return r}const ge={query:"",matches:[],currentIndex:-1,caseSensitive:!1,isOpen:!1};function Ct({chunks:t,onNavigateToChunk:s}){const[n,r]=o.useState(ge),a=o.useMemo(()=>Nt(t),[t]),i=o.useCallback(()=>{r(h=>({...h,isOpen:!0}))},[]),u=o.useCallback(()=>{r(h=>({...h,isOpen:!1}))},[]),d=o.useCallback(()=>{r(ge)},[]),l=o.useCallback(h=>{const b=be(a,h,n.caseSensitive);r(v=>({...v,query:h,matches:b,currentIndex:b.length>0?0:-1})),b.length>0&&s&&s(b[0].chunkIndex)},[a,n.caseSensitive,s]),x=o.useCallback(()=>{r(h=>{const b=!h.caseSensitive,v=be(a,h.query,b);return{...h,caseSensitive:b,matches:v,currentIndex:v.length>0?0:-1}})},[a]),c=o.useCallback(()=>{r(h=>{if(h.matches.length===0)return h;const b=(h.currentIndex+1)%h.matches.length,v=h.matches[b];return v&&s&&s(v.chunkIndex),{...h,currentIndex:b}})},[s]),f=o.useCallback(()=>{r(h=>{if(h.matches.length===0)return h;const b=h.currentIndex<=0?h.matches.length-1:h.currentIndex-1,v=h.matches[b];return v&&s&&s(v.chunkIndex),{...h,currentIndex:b}})},[s]),m=o.useCallback(h=>{r(b=>{if(h<0||h>=b.matches.length)return b;const v=b.matches[h];return v&&s&&s(v.chunkIndex),{...b,currentIndex:h}})},[s]),g=o.useCallback(h=>n.matches.filter(b=>b.chunkIndex===h),[n.matches]),y=o.useMemo(()=>n.currentIndex>=0&&n.currentIndex<n.matches.length?n.matches[n.currentIndex]??null:null,[n.matches,n.currentIndex]);return{searchState:n,isSearchOpen:n.isOpen,openSearch:i,closeSearch:u,setQuery:l,toggleCaseSensitive:x,nextMatch:c,previousMatch:f,goToMatch:m,clearSearch:d,getMatchesForChunk:g,currentMatch:y,totalMatches:n.matches.length}}const It=10,St=400,Lt=5,Tt=300*1e3,Z=new Map;function Le(t){return t.trim().toLowerCase().slice(0,100)}function Ot(t){const s=Le(t),n=Z.get(s);return n&&Date.now()-n.timestamp<Tt?n.results:(n&&Z.delete(s),null)}function Mt(t,s){const n=Le(t);if(Z.size>=50){const r=Z.keys().next().value;r&&Z.delete(r)}Z.set(n,{results:s,timestamp:Date.now()})}function Rt({selectionText:t,filePath:s,chunkIndex:n,enabled:r=!0}){const[a,i]=o.useState([]),[u,d]=o.useState(!1),[l,x]=o.useState(null),c=o.useRef(null),f=o.useRef(null),m=o.useRef(null),g=o.useCallback(()=>{i([]),x(null),d(!1),m.current=null,f.current&&(clearTimeout(f.current),f.current=null),c.current&&(c.current.abort(),c.current=null)},[]);return o.useEffect(()=>{if(!r){g();return}if(!t){g();return}if(t.length<It){g();return}if(t===m.current)return;f.current&&clearTimeout(f.current),c.current&&c.current.abort();const y=Ot(t);if(y){const h=y.filter(b=>!(b.filePath===s&&b.chunkIndex===n));i(h),x(t),m.current=t;return}return f.current=setTimeout(async()=>{d(!0),c.current=new AbortController;try{const h=await ot(t,Lt),b=h.filter(v=>!(v.filePath===s&&v.chunkIndex===n));Mt(t,h),i(b),x(t),m.current=t}catch(h){h instanceof Error&&h.name!=="AbortError"&&console.error("Auto-selection search failed:",h)}finally{d(!1)}},St),()=>{f.current&&clearTimeout(f.current)}},[t,s,n,r,g]),o.useEffect(()=>()=>{f.current&&clearTimeout(f.current),c.current&&c.current.abort()},[]),{results:a,isSearching:u,searchedText:l,clearResults:g}}const ve=[{color:"yellow",bg:"bg-yellow-300",ring:"ring-yellow-400",label:"Yellow"},{color:"green",bg:"bg-green-300",ring:"ring-green-400",label:"Green"},{color:"blue",bg:"bg-blue-300",ring:"ring-blue-400",label:"Blue"},{color:"pink",bg:"bg-pink-300",ring:"ring-pink-400",label:"Pink"},{color:"purple",bg:"bg-purple-300",ring:"ring-purple-400",label:"Purple"}];function $t({highlight:t,annotation:s,onUpdateNote:n,onDeleteNote:r,onDeleteHighlight:a,onChangeColor:i}){const[u,d]=o.useState(!1),[l,x]=o.useState(s?.note||""),[c,f]=o.useState(!1),m=o.useCallback(()=>{l.trim()&&n(l.trim()),d(!1)},[l,n]),g=o.useCallback(h=>{h.key==="Enter"&&!h.shiftKey&&(h.preventDefault(),m()),h.key==="Escape"&&(d(!1),x(s?.note||""))},[m,s?.note]),y=ve.find(h=>h.color===t.color);return e.jsxs(R.div,{initial:{opacity:0,x:10},animate:{opacity:1,x:0},exit:{opacity:0,x:-10},className:"rounded-lg border shadow-sm overflow-hidden",style:{background:"var(--ws-surface-raised)",borderColor:"var(--ws-border)"},children:[e.jsx("div",{className:"px-3 py-2 border-b",style:{background:"var(--ws-surface-1)",borderColor:"var(--ws-border)"},children:e.jsxs("p",{className:"text-xs italic line-clamp-2",style:{color:"var(--ws-text-muted)"},children:['"',t.text.length>60?`${t.text.slice(0,60)}...`:t.text,'"']})}),e.jsx("div",{className:"p-3",children:u?e.jsxs("div",{children:[e.jsx("textarea",{value:l,onChange:h=>x(h.target.value),onKeyDown:g,onBlur:m,placeholder:"Add a note...",className:"w-full px-2 py-1.5 text-sm rounded border-0 resize-none focus:ring-2 focus:ring-blue-500",style:{background:"var(--ws-surface-1)",color:"var(--ws-text)"},rows:3}),e.jsxs("div",{className:"flex justify-end gap-2 mt-2",children:[e.jsx("button",{type:"button",onClick:()=>{d(!1),x(s?.note||"")},className:"px-2 py-1 text-xs",style:{color:"var(--ws-text-secondary)"},children:"Cancel"}),e.jsx("button",{type:"button",onClick:m,className:"px-2 py-1 text-xs rounded",style:{background:"var(--ws-accent)",color:"white"},children:"Save"})]})]}):e.jsx("div",{children:s?.note?e.jsx("button",{type:"button",className:"text-left text-sm cursor-pointer",style:{color:"var(--ws-text-secondary)"},onClick:()=>d(!0),children:s.note}):e.jsx("button",{type:"button",onClick:()=>d(!0),className:"text-sm italic",style:{color:"var(--ws-text-muted)"},children:"+ Add note..."})})}),e.jsxs("div",{className:"flex items-center justify-between px-3 py-2 border-t",style:{borderColor:"var(--ws-border-subtle)"},children:[e.jsxs("div",{className:"relative",children:[e.jsx("button",{type:"button",onClick:()=>f(!c),className:`w-5 h-5 rounded-full ${y?.bg} ring-1`,style:{"--tw-ring-color":"var(--ws-border)"},title:"Change color"}),c&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-10",onClick:()=>f(!1),onKeyDown:h=>h.key==="Escape"&&f(!1),role:"button",tabIndex:0,"aria-label":"Close color picker"}),e.jsx("div",{className:"absolute bottom-full left-0 mb-2 z-20 flex gap-1 p-1.5 rounded-lg shadow-lg border",style:{background:"var(--ws-surface-raised)",borderColor:"var(--ws-border)"},children:ve.map(({color:h,bg:b,ring:v})=>e.jsx("button",{type:"button",onClick:()=>{i(h),f(!1)},className:`w-5 h-5 rounded-full ${b} hover:ring-2 ${v} transition-all ${h===t.color?"ring-2":""}`,title:h},h))})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s&&e.jsx("button",{type:"button",onClick:r,className:"text-xs",style:{color:"var(--ws-text-muted)"},title:"Delete note",children:"Remove note"}),e.jsx("button",{type:"button",onClick:a,className:"p-1",style:{color:"var(--ws-text-muted)"},title:"Delete highlight",children:e.jsx(Dt,{className:"w-4 h-4"})})]})]})]})}function Dt({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"})})}function Et({items:t,onNavigate:s,onSaveTrail:n,canSaveTrail:r}){return t.length===0?null:e.jsxs("nav",{className:"flex items-center gap-1 px-4 py-2 border-b overflow-x-auto",style:{background:"var(--ws-surface-1)",borderColor:"var(--ws-border)"},"aria-label":"Breadcrumb",children:[e.jsxs("ol",{className:"flex items-center gap-1",children:[e.jsx("li",{children:e.jsx("button",{type:"button",onClick:()=>s({filePath:"",label:"Search",chunkIndex:void 0}),className:"transition-colors",style:{color:"var(--ws-text-muted)"},children:e.jsx(At,{})})}),t.map((a,i)=>e.jsxs(R.li,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},className:"flex items-center",children:[e.jsx("span",{className:"mx-1",style:{color:"var(--ws-text-muted)"},children:"/"}),a.connectionReason&&e.jsxs("span",{className:"text-xs italic mr-1",style:{color:"var(--ws-text-muted)"},children:['via "',a.connectionReason,'"']}),e.jsxs("button",{type:"button",onClick:()=>s(a),disabled:i===t.length-1,className:"text-sm truncate max-w-[150px] px-2 py-0.5 rounded transition-colors",style:i===t.length-1?{color:"var(--ws-text)",fontWeight:500,background:"var(--ws-surface-1)"}:{color:"var(--ws-text-secondary)"},title:`${a.label}${a.chunkIndex!==void 0?` #${a.chunkIndex}`:""}`,children:[a.label,a.chunkIndex!==void 0&&e.jsxs("span",{className:"ml-1",style:{color:"var(--ws-text-muted)"},children:["#",a.chunkIndex]})]})]},`${a.filePath}-${a.chunkIndex??"doc"}`))]}),n&&r&&t.length>1&&e.jsx(R.button,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},type:"button",onClick:n,className:"ml-auto px-2 py-1 text-xs font-medium rounded transition-colors whitespace-nowrap",style:{color:"var(--ws-accent)"},children:"Save Trail"})]})}function At(){return e.jsx("svg",{className:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})})}const Kt=[{color:"yellow",bg:"bg-yellow-300",ring:"ring-yellow-400"},{color:"green",bg:"bg-green-300",ring:"ring-green-400"},{color:"blue",bg:"bg-blue-300",ring:"ring-blue-400"},{color:"pink",bg:"bg-pink-300",ring:"ring-pink-400"},{color:"purple",bg:"bg-purple-300",ring:"ring-purple-400"}],Bt=[{action:"related",icon:"üîç",label:"Related",title:"Find related content in vault"},{action:"support",icon:"‚úì",label:"Support",title:"Find supporting evidence"},{action:"contradict",icon:"‚úó",label:"Contradict",title:"Find contradicting content"},{action:"compare",icon:"‚öñÔ∏è",label:"Compare",title:"Compare with other chunks"},{action:"pin",icon:"üìå",label:"Pin",title:"Pin selection as note"}];function Pt({rect:t,onSelectColor:s,onClose:n,onSelectionAction:r,isActionLoading:a=!1,showMarginIndicator:i=!0}){const u=!!r,d=i&&!u,l=u?220:160,x=u?80:d?70:44,c=8,f=t.left+t.width/2-l/2,m=t.top-x-c+window.scrollY,g=Math.max(8,Math.min(f,window.innerWidth-l-8)),y=m<8?t.bottom+c+window.scrollY:m;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-50",onClick:n,onKeyDown:h=>h.key==="Escape"&&n(),role:"button",tabIndex:0,"aria-label":"Close popover"}),e.jsxs(R.div,{initial:{opacity:0,y:4},animate:{opacity:1,y:0},exit:{opacity:0,y:4},transition:{duration:.1},className:"fixed z-50 rounded-lg shadow-xl border p-2",style:{background:"var(--ws-surface-raised)",borderColor:"var(--ws-border)",left:g,top:y,minWidth:l},children:[e.jsx("div",{className:"flex items-center justify-center gap-1 mb-1.5",children:Kt.map(({color:h,bg:b,ring:v})=>e.jsx("button",{type:"button",onClick:()=>s(h),className:`w-7 h-7 rounded-full ${b} hover:ring-2 ${v} transition-all`,title:`Highlight ${h}`},h))}),d&&e.jsx("div",{className:"flex items-center justify-center gap-1.5 pt-1.5 border-t",style:{borderColor:"var(--ws-border)"},children:e.jsxs("span",{className:"text-xs text-violet-600 dark:text-violet-400 flex items-center gap-1",children:[e.jsx(Ht,{className:"w-3 h-3"}),"See margin",e.jsx(Ft,{className:"w-3 h-3"})]})}),u&&e.jsx("div",{className:"flex items-center justify-center gap-1 pt-1.5 border-t",style:{borderColor:"var(--ws-border)"},children:Bt.map(({action:h,icon:b,title:v})=>e.jsx("button",{type:"button",onClick:()=>r(h),disabled:a,className:`
                  flex items-center justify-center w-8 h-8 rounded-md text-sm
                  transition-all
                  ${a?"opacity-50 cursor-not-allowed":""}
                `,title:v,children:b},h))})]})]})}function Ht({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"})})}function Ft({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})}const Wt={yellow:"bg-yellow-200 dark:bg-yellow-800/60",green:"bg-green-200 dark:bg-green-800/60",blue:"bg-blue-200 dark:bg-blue-800/60",pink:"bg-pink-200 dark:bg-pink-800/60",purple:"bg-purple-200 dark:bg-purple-800/60"},zt={yellow:"hover:bg-yellow-300 dark:hover:bg-yellow-700/60",green:"hover:bg-green-300 dark:hover:bg-green-700/60",blue:"hover:bg-blue-300 dark:hover:bg-blue-700/60",pink:"hover:bg-pink-300 dark:hover:bg-pink-700/60",purple:"hover:bg-purple-300 dark:hover:bg-purple-700/60"};function Vt(t,s,n){const r=new Set;r.add(0),r.add(t.length);const a=[...s,...n];for(const d of a)d.startOffset>=0&&d.startOffset<=t.length&&r.add(d.startOffset),d.endOffset>=0&&d.endOffset<=t.length&&r.add(d.endOffset);const i=Array.from(r).sort((d,l)=>d-l),u=[];for(let d=0;d<i.length-1;d++){const l=i[d],x=i[d+1];if(l>=x)continue;const c=a.filter(f=>f.startOffset<=l&&f.endOffset>=x);u.push({text:t.slice(l,x),types:c})}return u}function Gt(t){return t.map(s=>({startOffset:s.range.startOffset,endOffset:s.range.endOffset,type:"annotation",highlightId:s.id,color:s.color}))}function Ut(t,s,n){let r=0;const a=[];let i=0;for(const u of t)u.chunkIndex<s&&i++;for(const u of t){if(u.chunkIndex!==s)continue;const d=i+r;a.push({startOffset:u.startOffset,endOffset:u.endOffset,type:d===n?"search-current":"search-match"}),r++}return a}function _t({text:t,highlights:s,searchMatches:n=[],currentSearchIndex:r=-1,chunkIndex:a,onHighlightClick:i}){const u=o.useMemo(()=>Gt(s),[s]),d=o.useMemo(()=>Ut(n,a,r),[n,a,r]),l=o.useMemo(()=>Vt(t,u,d),[t,u,d]),x=o.useMemo(()=>{const c=new Map;for(const f of s)c.set(f.id,f);return c},[s]);return e.jsx("span",{className:"whitespace-pre-wrap",children:l.map((c,f)=>{const m=c.types.find(b=>b.type==="annotation"),g=c.types.find(b=>b.type==="search-current"),y=c.types.find(b=>b.type==="search-match"),h=["rounded","transition-colors"];if(m?.color&&(h.push(Wt[m.color]),h.push(zt[m.color]),h.push("cursor-pointer","px-0.5")),g&&(h.push("ring-2","ring-orange-500","dark:ring-orange-400","ring-offset-1","ring-offset-white"),m||h.push("bg-orange-100","dark:bg-orange-900/30")),y&&!g&&h.push("underline","decoration-dotted","decoration-orange-500","dark:decoration-orange-400","underline-offset-2"),m?.highlightId){const b=x.get(m.highlightId);return e.jsx("span",{className:h.join(" "),onClick:v=>{v.stopPropagation(),b&&i&&i(b)},onKeyDown:v=>{(v.key==="Enter"||v.key===" ")&&(v.preventDefault(),b&&i&&i(b))},role:"button",tabIndex:0,"data-highlight-id":m.highlightId,children:c.text},`highlight-${m.highlightId}-${f}`)}return g||y?e.jsx("span",{className:h.join(" "),"data-search-match":"true",children:c.text},`search-${f}-${c.text.length}`):e.jsx("span",{children:c.text},`text-${f}-${c.text.length}`)})})}function Qt({chunk:t,isActive:s,onRegister:n,onClick:r,showChunkNumbers:a=!0,highlights:i=[],onCreateHighlight:u,onHighlightClick:d,searchMatches:l=[],currentSearchIndex:x=-1,isBookmarked:c=!1,onSelectionAction:f,isSelectionActionLoading:m=!1}){const g=o.useRef(null),y=o.useRef(null),h=o.useRef(null),b=r?y:g,{selection:v,clearSelection:w}=wt({containerRef:h,chunkText:t.text,enabled:!!u}),k=o.useCallback(B=>{v&&u&&(u({startOffset:v.startOffset,endOffset:v.endOffset},v.text,v.contextBefore,v.contextAfter,B),w())},[v,u,w]),S=o.useCallback(B=>{v&&f&&(f(B,{text:v.text,startOffset:v.startOffset,endOffset:v.endOffset,contextBefore:v.contextBefore,contextAfter:v.contextAfter}),B==="pin"&&w())},[v,f,w]);o.useEffect(()=>(n(t.chunkIndex,b.current),()=>{n(t.chunkIndex,null)}),[t.chunkIndex,n,b]);const E=e.jsx("div",{ref:h,children:i.length>0||l.length>0?e.jsx(_t,{text:t.text,highlights:i,searchMatches:l,currentSearchIndex:x,chunkIndex:t.chunkIndex,onHighlightClick:d}):e.jsx("span",{className:"whitespace-pre-wrap",children:t.text})}),K=e.jsxs(e.Fragment,{children:[a&&e.jsxs("div",{className:"absolute -left-1 top-5 flex items-center gap-1.5",children:[e.jsxs("span",{className:"book-chunk-badge",children:["¬ß",t.chunkIndex]}),c&&e.jsx(Zt,{className:"w-3.5 h-3.5 text-amber-600 dark:text-amber-500"})]}),e.jsx("div",{className:"pl-8 pr-4 max-w-none book-text",style:{fontSize:"var(--reader-font-size, 1.05rem)",lineHeight:"var(--reader-line-height, 1.85)",fontFamily:"var(--reader-font-family, 'Georgia', 'Palatino Linotype', serif)"},children:E}),s&&e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-0.5 bg-amber-500/60 dark:bg-amber-600/50"}),e.jsx(A,{children:v&&u&&e.jsx(Pt,{rect:v.rect,onSelectColor:k,onClose:w,onSelectionAction:f?S:void 0,isActionLoading:m})})]}),H=`
    book-page group relative py-6 px-8 mb-4 transition-all duration-200 text-left w-full
    ${s?"book-chunk-active":""}
  `;return r?e.jsx("button",{ref:y,id:`chunk-${t.chunkIndex}`,type:"button",className:H,onClick:r,children:K}):e.jsx("div",{ref:g,id:`chunk-${t.chunkIndex}`,className:H,children:K})}function Zt({className:t}){return e.jsx("svg",{className:t,fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z"})})}function Te({chunks:t,activeChunkIndex:s,onRegisterChunk:n,onChunkClick:r,scrollToChunk:a,showChunkNumbers:i=!0,getHighlightsForChunk:u,onCreateHighlight:d,onHighlightClick:l,getSearchMatchesForChunk:x,currentSearchIndex:c=-1,isChunkBookmarked:f}){return o.useEffect(()=>{if(a!=null){const m=document.getElementById(`chunk-${a}`);m&&requestAnimationFrame(()=>{m.scrollIntoView({behavior:"smooth",block:"center"})})}},[a]),t.length===0?e.jsx("div",{className:"flex items-center justify-center h-64",style:{color:"var(--ws-text-muted)"},children:e.jsx("p",{children:"No content to display"})}):e.jsx("div",{className:"max-w-3xl mx-auto space-y-2",children:t.map(m=>{const g=u?.(m.chunkIndex)??[],y=x?.(m.chunkIndex)??[],h=f?.(m.chunkIndex)??!1;return e.jsx(Qt,{chunk:m,isActive:s===m.chunkIndex,onRegister:n,onClick:r?()=>r(m):void 0,showChunkNumbers:i,highlights:g,onCreateHighlight:d?(b,v,w,k,S)=>d(m.chunkIndex,b,v,w,k,S):void 0,onHighlightClick:l,searchMatches:y,currentSearchIndex:c,isBookmarked:h},`${m.filePath}-${m.chunkIndex}`)})})}const Xt={hidden:{opacity:0,y:-15,rotate:-3,scale:.95},visible:t=>({opacity:1,y:0,rotate:-.3,scale:1,transition:{delay:t*.06,duration:.3,ease:"easeOut"}}),exit:{opacity:0,x:-20,transition:{duration:.15}}};function Yt(t){switch(t){case"backlink":return"zettel-backlink";case"forward":return"zettel-forward";case"semantic":return"zettel-semantic"}}function Jt(t){switch(t){case"backlink":return"Links here";case"forward":return"Links to";case"semantic":return"Related"}}function qt(t){const s=t.split(/[/\\]/);return s[s.length-1]||t}function ye(t){return`${Math.round((1-t)*100)}%`}function Y({filePath:t,chunkIndex:s,previewText:n,type:r,score:a,sharedKeywords:i=[],onNavigate:u,onPin:d,isPinned:l=!1,animationIndex:x=0}){const c=qt(t),f=Jt(r),m=Yt(r);return e.jsxs(R.button,{type:"button",onClick:u,custom:x,variants:Xt,initial:"hidden",animate:"visible",exit:"exit",className:`
        zettel-slip ${m}
        w-full text-left cursor-pointer
        focus:outline-none focus:ring-2 focus:ring-amber-400 dark:focus:ring-amber-600
        ${l?"ring-2 ring-amber-500 dark:ring-amber-400":""}
      `,children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1.5",children:[e.jsxs("div",{className:"flex items-center gap-1.5 min-w-0 flex-1",children:[e.jsx(es,{type:r}),e.jsx("span",{className:"text-xs font-medium text-stone-600 dark:text-stone-400 truncate font-serif",title:t,children:c}),e.jsxs("span",{className:"text-xs text-stone-400 dark:text-stone-500 font-mono",children:["#",s]})]}),a!==void 0&&e.jsx("span",{className:"text-xs px-1.5 py-0.5 rounded bg-stone-200/50 dark:bg-stone-700/50 text-stone-600 dark:text-stone-400",title:`Similarity: ${ye(a)}`,children:ye(a)})]}),e.jsxs("p",{className:"text-sm text-stone-700 dark:text-stone-300 line-clamp-3 font-serif leading-relaxed",children:[n.slice(0,180),n.length>180&&"..."]}),i.length>0&&e.jsx("div",{className:"flex flex-wrap gap-1 mt-2",children:i.slice(0,3).map(g=>e.jsx("span",{className:"px-1.5 py-0.5 text-xs bg-amber-100/60 dark:bg-amber-900/30 text-amber-700 dark:text-amber-400 rounded font-sans",children:g},g))}),e.jsxs("div",{className:"flex items-center justify-between mt-2 pt-1.5 border-t border-stone-200/50 dark:border-stone-700/50",children:[e.jsx("span",{className:"text-xs text-stone-500 dark:text-stone-400 italic",children:f}),e.jsx("div",{className:"flex items-center gap-1",children:d&&e.jsx("span",{role:"button",tabIndex:0,onClick:g=>{g.stopPropagation(),d()},onKeyDown:g=>{(g.key==="Enter"||g.key===" ")&&(g.stopPropagation(),g.preventDefault(),d())},className:`
                p-1 rounded transition-colors
                ${l?"text-amber-600 dark:text-amber-400":"text-stone-400 hover:text-amber-500 dark:text-stone-500 dark:hover:text-amber-400"}
              `,title:l?"Unpin":"Pin",children:e.jsx(ts,{className:"w-3.5 h-3.5"})})})]})]})}function es({type:t}){const s={backlink:"bg-blue-500",forward:"bg-emerald-500",semantic:"bg-violet-500"}[t];return e.jsx("span",{className:`w-2 h-2 rounded-full ${s} flex-shrink-0`,"aria-hidden":"true"})}function ts({className:t}){return e.jsx("svg",{className:t,fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{d:"M5 5a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 19V5z"})})}function ke({message:t}){return e.jsxs(R.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center py-6 text-stone-500 dark:text-stone-400",children:[e.jsx(ss,{}),e.jsx("p",{className:"mt-2 text-sm font-serif italic",children:t})]})}function ss(){return e.jsx("svg",{className:"mx-auto h-10 w-10 text-stone-300 dark:text-stone-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:1.5,d:"M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"})})}function Q({title:t,count:s,icon:n}){return e.jsxs("div",{className:"flex items-center gap-2 px-1 py-2",children:[n&&e.jsx("span",{className:"text-stone-400 dark:text-stone-500",children:n}),e.jsx("h4",{className:"text-xs font-semibold text-stone-600 dark:text-stone-400 uppercase tracking-wide font-sans",children:t}),s!==void 0&&s>0&&e.jsxs("span",{className:"text-xs text-stone-400 dark:text-stone-500",children:["(",s,")"]})]})}function le(){return e.jsxs("div",{className:"zettel-slip zettel-semantic animate-pulse",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("div",{className:"w-2 h-2 rounded-full bg-stone-300 dark:bg-stone-600"}),e.jsx("div",{className:"h-3 w-24 bg-stone-300 dark:bg-stone-600 rounded"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"h-3 w-full bg-stone-200 dark:bg-stone-700 rounded"}),e.jsx("div",{className:"h-3 w-4/5 bg-stone-200 dark:bg-stone-700 rounded"}),e.jsx("div",{className:"h-3 w-2/3 bg-stone-200 dark:bg-stone-700 rounded"})]})]})}function ns({relatedChunks:t,isLoading:s,activeChunkIndex:n,currentFilePath:r,onNavigateToChunk:a,pinnedChunkKeys:i,onTogglePin:u,highlights:d=[],annotations:l=new Map,onUpdateNote:x,onDeleteNote:c,onDeleteHighlight:f,onChangeHighlightColor:m,backlinks:g=[],outgoingLinks:y=[],selectionSearchResults:h,isSelectionSearchLoading:b=!1,onClearSelectionSearch:v,autoSelectionResults:w=[],isAutoSearching:k=!1,selectionText:S=null}){const E=t.filter(p=>p.score<.7),K=d.length>0,H=g.length>0,B=y.length>0,W=w.length>0||k,T=h||b,N=[...g].sort((p,O)=>{const F=p.sourceKey.filePath===r,C=O.sourceKey.filePath===r;if(F!==C)return F?-1:1;const z=!!p.label,U=!!O.label;return z!==U?z?-1:1:new Date(O.createdAt).getTime()-new Date(p.createdAt).getTime()}),D=[...y].sort((p,O)=>{const F=p.targetKey.filePath===r,C=O.targetKey.filePath===r;if(F!==C)return F?-1:1;const z=!!p.label,U=!!O.label;return z!==U?z?-1:1:new Date(O.createdAt).getTime()-new Date(p.createdAt).getTime()});return e.jsxs("div",{className:"h-full flex flex-col zettel-margin",children:[e.jsxs("div",{className:"zettel-header flex items-center justify-between",children:[e.jsxs("h3",{className:"text-sm font-semibold text-stone-700 dark:text-stone-300 font-serif",children:["Connections",n!==null&&e.jsxs("span",{className:"ml-2 text-stone-400 dark:text-stone-500 font-mono text-xs",children:["#",n]})]}),s&&e.jsx(q,{className:"w-4 h-4 text-stone-400"})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-3 space-y-4",children:[K&&e.jsxs("div",{className:"border-b border-stone-200/50 dark:border-stone-700/50 pb-4",children:[e.jsx(Q,{title:"Notes",count:d.length,icon:e.jsx(rs,{className:"w-3.5 h-3.5"})}),e.jsx("div",{className:"space-y-3 mt-2",children:e.jsx(A,{mode:"popLayout",children:d.map(p=>e.jsx($t,{highlight:p,annotation:l.get(p.id),onUpdateNote:O=>x?.(p.id,O),onDeleteNote:()=>{const O=l.get(p.id);O&&c?.(O.id)},onDeleteHighlight:()=>f?.(p.id),onChangeColor:O=>m?.(p.id,O)},p.id))})})]}),W&&e.jsxs("div",{className:"border-b border-stone-200/50 dark:border-stone-700/50 pb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(Q,{title:"From Selection",count:w.length,icon:e.jsx(is,{className:"w-3.5 h-3.5"})}),S&&e.jsxs("span",{className:"zettel-selection-pill truncate max-w-[150px]",title:S,children:['"',S.slice(0,30),S.length>30?"...":"",'"']})]}),e.jsx("div",{className:"space-y-2 mt-2",children:k?e.jsxs("div",{className:"zettel-searching",children:[e.jsx(q,{className:"w-4 h-4 text-violet-500"}),e.jsx("span",{className:"text-xs text-violet-600 dark:text-violet-400 font-serif italic",children:"Finding connections..."})]}):w.length===0?e.jsx("p",{className:"text-xs text-stone-500 dark:text-stone-400 italic font-serif py-2",children:"No related content found"}):e.jsx(A,{mode:"popLayout",children:w.map((p,O)=>e.jsx(Y,{filePath:p.filePath,chunkIndex:p.chunkIndex,previewText:p.text,type:"semantic",score:p.score,onNavigate:()=>a(p.filePath,p.chunkIndex),onPin:u?()=>u(p.filePath,p.chunkIndex):void 0,isPinned:i?.has(`${p.filePath}:${p.chunkIndex}`)??!1,animationIndex:O},`${p.filePath}:${p.chunkIndex}`))})})]}),T&&!W&&e.jsxs("div",{className:"border-b border-stone-200/50 dark:border-stone-700/50 pb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx(Q,{title:h?us(h.action):"Searching...",count:h?.results.length,icon:e.jsx(cs,{className:"w-3.5 h-3.5"})}),v&&e.jsx("button",{type:"button",onClick:v,className:"text-stone-400 hover:text-stone-600 dark:hover:text-stone-200 transition-colors",title:"Close",children:e.jsx(ds,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"space-y-2 mt-2",children:b?e.jsx(le,{}):h?.results.length===0?e.jsx(ke,{message:"No results found"}):e.jsx(A,{mode:"popLayout",children:h?.results.map((p,O)=>e.jsx(Y,{filePath:p.filePath,chunkIndex:p.chunkIndex,previewText:p.text,type:"semantic",score:p.score,onNavigate:()=>a(p.filePath,p.chunkIndex),onPin:u?()=>u(p.filePath,p.chunkIndex):void 0,isPinned:i?.has(`${p.filePath}:${p.chunkIndex}`)??!1,animationIndex:O},`${p.filePath}:${p.chunkIndex}`))})})]}),H&&e.jsxs("div",{className:"border-b border-stone-200/50 dark:border-stone-700/50 pb-4",children:[e.jsx(Q,{title:"Links Here",count:N.length,icon:e.jsx(os,{className:"w-3.5 h-3.5"})}),e.jsx("div",{className:"space-y-2 mt-2",children:e.jsx(A,{mode:"popLayout",children:N.map((p,O)=>e.jsx(Y,{filePath:p.sourceKey.filePath,chunkIndex:p.sourceKey.chunkIndex,previewText:p.sourceText||"No preview available",type:"backlink",sharedKeywords:p.label?[p.label]:void 0,onNavigate:()=>a(p.sourceKey.filePath,p.sourceKey.chunkIndex),animationIndex:O},p.id))})})]}),B&&e.jsxs("div",{className:"border-b border-stone-200/50 dark:border-stone-700/50 pb-4",children:[e.jsx(Q,{title:"Links From",count:D.length,icon:e.jsx(ls,{className:"w-3.5 h-3.5"})}),e.jsx("div",{className:"space-y-2 mt-2",children:e.jsx(A,{mode:"popLayout",children:D.map((p,O)=>e.jsx(Y,{filePath:p.targetKey.filePath,chunkIndex:p.targetKey.chunkIndex,previewText:p.targetText||"No preview available",type:"forward",sharedKeywords:p.label?[p.label]:void 0,onNavigate:()=>a(p.targetKey.filePath,p.targetKey.chunkIndex),animationIndex:O},p.id))})})]}),e.jsxs("div",{children:[e.jsx(Q,{title:"Suggested",count:E.length,icon:e.jsx(as,{className:"w-3.5 h-3.5"})}),e.jsx("div",{className:"space-y-2 mt-2",children:e.jsx(A,{mode:"popLayout",children:E.length===0&&!s?e.jsx(ke,{message:n!==null?"No related content found":"Scroll to see related content"}):s&&E.length===0?e.jsxs(e.Fragment,{children:[e.jsx(le,{}),e.jsx(le,{})]}):E.map((p,O)=>{const F=`${p.filePath}:${p.chunkIndex}`,C=i?.has(F)??!1;return e.jsx(Y,{filePath:p.filePath,chunkIndex:p.chunkIndex,previewText:p.text,type:"semantic",score:p.score,sharedKeywords:p.explanation?.sharedKeywords,onNavigate:()=>a(p.filePath,p.chunkIndex),onPin:u?()=>u(p.filePath,p.chunkIndex):void 0,isPinned:C,animationIndex:O},F)})})})]})]})]})}function rs({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"})})}function as({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"})})}function os({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M11 19l-7-7 7-7m8 14l-7-7 7-7"})})}function ls({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 5l7 7-7 7M5 5l7 7-7 7"})})}function cs({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}function is({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 9l4-4 4 4m0 6l-4 4-4-4"})})}function ds({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}function us(t){switch(t){case"related":return"Related";case"support":return"Supporting";case"contradict":return"Contradicting";case"compare":return"Compare";case"pin":return"Pinned";default:return"Results"}}function xs({isOpen:t,onToggle:s,filePath:n,activeChunkIndex:r,relatedChunks:a,pins:i,onNavigateToChunk:u}){const{graphData:d,currentNodeId:l}=lt({filePath:n,activeChunkIndex:r,relatedChunks:a,pins:i}),x=o.useMemo(()=>{const f=new Set;for(const m of i)f.add(`${m.sourceKey.filePath}:${m.sourceKey.chunkIndex}`),f.add(`${m.targetKey.filePath}:${m.targetKey.chunkIndex}`);return f},[i]),c=f=>{u(f.filePath,f.chunkIndex)};return e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",onClick:s,className:"flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-lg transition-colors",style:{color:"var(--ws-text-secondary)"},title:t?"Hide knowledge graph":"Show knowledge graph",children:[e.jsx(je,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Graph"}),d.nodes.length>0&&e.jsxs("span",{className:"text-xs",style:{color:"var(--ws-text-muted)"},children:["(",d.nodes.length,")"]})]}),e.jsx(A,{children:t&&e.jsx(R.div,{initial:{height:0,opacity:0},animate:{height:300,opacity:1},exit:{height:0,opacity:0},transition:{duration:.2},className:"absolute bottom-0 left-0 right-0 z-30 border-t overflow-hidden",style:{borderColor:"var(--ws-border)",background:"var(--ws-surface-raised)"},children:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b",style:{borderColor:"var(--ws-border)",background:"var(--ws-surface-1)"},children:[e.jsxs("h3",{className:"text-sm font-medium",style:{color:"var(--ws-text-secondary)"},children:["Knowledge Graph",r!==null&&e.jsxs("span",{className:"ml-2",style:{color:"var(--ws-text-muted)"},children:["(centered on #",r,")"]})]}),e.jsx("button",{type:"button",onClick:s,className:"p-1 rounded",style:{color:"var(--ws-text-muted)"},children:e.jsx(hs,{className:"w-4 h-4"})})]}),e.jsx("div",{className:"flex-1 p-2",children:d.nodes.length===0?e.jsx("div",{className:"h-full flex items-center justify-center",style:{color:"var(--ws-text-muted)"},children:e.jsxs("div",{className:"text-center",children:[e.jsx(je,{className:"w-10 h-10 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No graph data available"}),e.jsx("p",{className:"text-xs mt-1",children:"Scroll through the document to load related content"})]})}):e.jsx(ct,{graphData:d,currentNodeId:l,pinnedNodeIds:x,onNodeClick:c})})]})})})]})}function je({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 10V3L4 14h7v7l9-11h-7z"})})}function hs({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}const fs=[{key:"j",description:"Navigate to next chunk"},{key:"k",description:"Navigate to previous chunk"},{key:"Space",description:"Toggle split view"},{key:"p",description:"Pin top margin suggestion"},{key:"/",description:"Open search"},{key:"?",description:"Show keyboard shortcuts"},{key:"Esc",description:"Close overlays"}];function ms({isOpen:t,onClose:s}){return e.jsx(A,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(R.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/50 backdrop-blur-sm",onClick:s}),e.jsx(R.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},transition:{duration:.15},className:"fixed inset-0 z-50 flex items-center justify-center p-4",onClick:n=>n.target===n.currentTarget&&s(),children:e.jsxs("div",{className:"w-full max-w-md rounded-xl shadow-2xl overflow-hidden",style:{background:"var(--ws-surface-raised)"},children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b",style:{borderColor:"var(--ws-border)"},children:[e.jsx("h2",{className:"text-lg font-semibold",style:{color:"var(--ws-text)"},children:"Keyboard Shortcuts"}),e.jsx("button",{type:"button",onClick:s,className:"p-1 rounded-lg transition-colors",style:{color:"var(--ws-text-muted)"},children:e.jsx(ps,{className:"w-5 h-5"})})]}),e.jsx("div",{className:"p-4",children:e.jsx("table",{className:"w-full",children:e.jsx("tbody",{className:"divide-y",style:{borderColor:"var(--ws-border-subtle)"},children:fs.map(n=>e.jsxs("tr",{className:"group",children:[e.jsx("td",{className:"py-2.5 pr-4",children:e.jsx("kbd",{className:"inline-flex items-center justify-center min-w-[2rem] px-2 py-1 text-sm font-mono font-semibold border rounded shadow-sm",style:{color:"var(--ws-text-secondary)",background:"var(--ws-surface-1)",borderColor:"var(--ws-border)"},children:n.key})}),e.jsx("td",{className:"py-2.5 text-sm",style:{color:"var(--ws-text-secondary)"},children:n.description})]},n.key))})})}),e.jsx("div",{className:"px-6 py-3 border-t",style:{background:"var(--ws-surface-1)",borderColor:"var(--ws-border)"},children:e.jsx("p",{className:"text-xs text-center",style:{color:"var(--ws-text-muted)"},children:"Shortcuts are disabled when typing in inputs or selecting text"})})]})})]})})}function ps({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}function bs({isOpen:t,onClose:s}){const{settings:n,setFontSize:r,setLineHeight:a,setFontFamily:i,setShowChunkNumbers:u,setShowHeatmap:d,resetSettings:l}=we();return e.jsx(A,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(R.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-40",onClick:s}),e.jsx(R.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.15},className:"absolute right-0 top-full mt-2 z-50 w-72 rounded-lg shadow-xl border p-4",style:{background:"var(--ws-surface-raised)",borderColor:"var(--ws-border)"},children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"block text-xs font-medium mb-2",style:{color:"var(--ws-text-secondary)"},children:"Font Size"}),e.jsx("div",{className:"flex gap-1",role:"group","aria-label":"Font size",children:["sm","base","lg","xl"].map(x=>e.jsxs("button",{type:"button",onClick:()=>r(x),className:"flex-1 px-2 py-1.5 text-sm rounded-md transition-colors",style:n.fontSize===x?{background:"var(--ws-accent-subtle)",color:"var(--ws-accent)",fontWeight:500}:{background:"var(--ws-surface-1)",color:"var(--ws-text-secondary)"},children:[x==="sm"&&"S",x==="base"&&"M",x==="lg"&&"L",x==="xl"&&"XL"]},x))})]}),e.jsxs("div",{children:[e.jsx("span",{className:"block text-xs font-medium mb-2",style:{color:"var(--ws-text-secondary)"},children:"Line Spacing"}),e.jsx("div",{className:"flex gap-1",role:"group","aria-label":"Line spacing",children:["tight","normal","relaxed"].map(x=>e.jsx("button",{type:"button",onClick:()=>a(x),className:"flex-1 px-2 py-1.5 text-sm rounded-md transition-colors capitalize",style:n.lineHeight===x?{background:"var(--ws-accent-subtle)",color:"var(--ws-accent)",fontWeight:500}:{background:"var(--ws-surface-1)",color:"var(--ws-text-secondary)"},children:x},x))})]}),e.jsx("div",{children:e.jsxs("label",{className:"block text-xs font-medium mb-2",style:{color:"var(--ws-text-secondary)"},children:["Font",e.jsxs("select",{value:n.fontFamily,onChange:x=>i(x.target.value),className:"mt-1 w-full px-3 py-2 text-sm border-0 rounded-md focus:ring-2 focus:ring-blue-500",style:{background:"var(--ws-surface-1)",color:"var(--ws-text-secondary)"},children:[e.jsx("option",{value:"sans",children:"Sans-serif"}),e.jsx("option",{value:"serif",children:"Serif"}),e.jsx("option",{value:"mono",children:"Monospace"})]})]})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm",style:{color:"var(--ws-text-secondary)"},children:"Show chunk numbers"}),e.jsx("button",{type:"button",onClick:()=>u(!n.showChunkNumbers),className:"relative inline-flex h-6 w-11 items-center rounded-full transition-colors",style:{background:n.showChunkNumbers?"var(--ws-accent)":"var(--ws-surface-2)"},children:e.jsx("span",{className:`
                      inline-block h-4 w-4 transform rounded-full bg-white transition-transform
                      ${n.showChunkNumbers?"translate-x-6":"translate-x-1"}
                    `})})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"text-sm",style:{color:"var(--ws-text-secondary)"},children:"Semantic heatmap"}),e.jsx("p",{className:"text-xs",style:{color:"var(--ws-text-muted)"},children:"Highlight connected terms"})]}),e.jsx("button",{type:"button",onClick:()=>d(!n.showHeatmap),className:"relative inline-flex h-6 w-11 items-center rounded-full transition-colors",style:{background:n.showHeatmap?"var(--ws-accent)":"var(--ws-surface-2)"},children:e.jsx("span",{className:`
                      inline-block h-4 w-4 transform rounded-full bg-white transition-transform
                      ${n.showHeatmap?"translate-x-6":"translate-x-1"}
                    `})})]}),e.jsx("div",{className:"pt-2 border-t",style:{borderColor:"var(--ws-border)"},children:e.jsx("button",{type:"button",onClick:l,className:"w-full px-3 py-1.5 text-sm rounded-md transition-colors",style:{color:"var(--ws-text-secondary)"},children:"Reset to defaults"})})]})})]})})}function gs({onClick:t}){return e.jsxs("button",{type:"button",onClick:t,className:"flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-lg transition-colors",style:{color:"var(--ws-text-secondary)"},title:"Reader settings",children:[e.jsx(vs,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Display"})]})}function vs({className:t}){return e.jsxs("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:[e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"}),e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 12a3 3 0 11-6 0 3 3 0 016 0z"})]})}function ys({isOpen:t,query:s,matches:n,currentIndex:r,caseSensitive:a,onQueryChange:i,onToggleCaseSensitive:u,onNextMatch:d,onPreviousMatch:l,onGoToMatch:x,onClose:c}){const f=o.useRef(null),m=o.useRef(null);o.useEffect(()=>{t&&requestAnimationFrame(()=>{f.current?.focus(),f.current?.select()})},[t]),o.useEffect(()=>{r>=0&&m.current&&m.current.querySelector(`[data-result-index="${r}"]`)?.scrollIntoView({block:"nearest",behavior:"smooth"})},[r]);const g=o.useCallback(y=>{switch(y.key){case"Escape":y.preventDefault(),c();break;case"Enter":y.preventDefault(),y.shiftKey?l():d();break;case"n":y.target!==f.current&&(y.preventDefault(),y.shiftKey?l():d());break;case"N":y.target!==f.current&&(y.preventDefault(),l());break}},[c,d,l]);return e.jsx(A,{children:t&&e.jsx(R.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.15},className:"fixed top-16 left-1/2 -translate-x-1/2 z-50 w-full max-w-lg px-4",onKeyDown:g,children:e.jsxs("div",{className:"rounded-xl shadow-2xl border overflow-hidden",style:{background:"var(--ws-surface-raised)",borderColor:"var(--ws-border)"},children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 border-b",style:{borderColor:"var(--ws-border)"},children:[e.jsx("span",{style:{color:"var(--ws-text-muted)"},children:e.jsx(js,{className:"w-5 h-5 flex-shrink-0"})}),e.jsx("input",{ref:f,type:"text",value:s,onChange:y=>i(y.target.value),placeholder:"Search in document...",className:"flex-1 bg-transparent placeholder-gray-400 focus:outline-none text-base",style:{color:"var(--ws-text)"}}),n.length>0&&e.jsxs("span",{className:"text-sm whitespace-nowrap px-2",style:{color:"var(--ws-text-muted)"},children:[r+1,"/",n.length]}),e.jsx("button",{type:"button",onClick:u,className:"p-1.5 rounded text-sm font-medium transition-colors",style:a?{background:"var(--ws-accent-subtle)",color:"var(--ws-accent)"}:{color:"var(--ws-text-muted)"},title:"Case sensitive (Aa)",children:"Aa"}),e.jsxs("div",{className:"flex items-center gap-1 border-l pl-2",style:{borderColor:"var(--ws-border)"},children:[e.jsx("button",{type:"button",onClick:l,disabled:n.length===0,className:"p-1 disabled:opacity-30 disabled:cursor-not-allowed rounded transition-colors",style:{color:"var(--ws-text-muted)"},title:"Previous match (N)",children:e.jsx(ws,{className:"w-4 h-4"})}),e.jsx("button",{type:"button",onClick:d,disabled:n.length===0,className:"p-1 disabled:opacity-30 disabled:cursor-not-allowed rounded transition-colors",style:{color:"var(--ws-text-muted)"},title:"Next match (n)",children:e.jsx(Ns,{className:"w-4 h-4"})})]}),e.jsx("button",{type:"button",onClick:c,className:"p-1 rounded transition-colors",style:{color:"var(--ws-text-muted)"},title:"Close (Esc)",children:e.jsx(Cs,{className:"w-4 h-4"})})]}),s.length>0&&e.jsx("div",{ref:m,className:"max-h-64 overflow-y-auto",children:n.length===0?e.jsx("div",{className:"px-4 py-6 text-center",style:{color:"var(--ws-text-muted)"},children:e.jsx("p",{className:"text-sm",children:"No matches found"})}):e.jsxs("div",{className:"py-1",children:[n.slice(0,50).map((y,h)=>e.jsxs("button",{"data-result-index":h,type:"button",onClick:()=>x(h),className:`w-full text-left px-4 py-2 transition-colors ${h===r?"border-l-2":""}`,style:h===r?{background:"var(--ws-accent-subtle)",borderColor:"var(--ws-accent)"}:{},children:[e.jsx("div",{className:"flex items-center gap-2 mb-0.5",children:e.jsxs("span",{className:"text-xs font-medium",style:{color:"var(--ws-text-muted)"},children:["Chunk #",y.chunkIndex]})}),e.jsx("p",{className:"text-sm line-clamp-2",style:{color:"var(--ws-text-secondary)"},children:ks(y.context,s,a)})]},`${y.chunkIndex}-${y.startOffset}`)),n.length>50&&e.jsxs("div",{className:"px-4 py-2 text-xs text-center border-t",style:{color:"var(--ws-text-muted)",borderColor:"var(--ws-border)"},children:["Showing first 50 of ",n.length," matches"]})]})}),s.length===0&&e.jsxs("div",{className:"px-4 py-3 text-xs",style:{color:"var(--ws-text-muted)",background:"var(--ws-surface-1)"},children:[e.jsxs("span",{className:"mr-4",children:[e.jsx("kbd",{className:"px-1.5 py-0.5 rounded",style:{background:"var(--ws-surface-2)",color:"var(--ws-text-secondary)"},children:"Enter"})," ","next"]}),e.jsxs("span",{className:"mr-4",children:[e.jsx("kbd",{className:"px-1.5 py-0.5 rounded",style:{background:"var(--ws-surface-2)",color:"var(--ws-text-secondary)"},children:"Shift+Enter"})," ","previous"]}),e.jsxs("span",{children:[e.jsx("kbd",{className:"px-1.5 py-0.5 rounded",style:{background:"var(--ws-surface-2)",color:"var(--ws-text-secondary)"},children:"Esc"})," ","close"]})]})]})})})}function ks(t,s,n){if(!s)return t;const r=n?s:s.toLowerCase(),i=(n?t:t.toLowerCase()).indexOf(r);if(i===-1)return t;const u=t.slice(0,i),d=t.slice(i,i+s.length),l=t.slice(i+s.length);return e.jsxs(e.Fragment,{children:[u,e.jsx("mark",{className:"bg-orange-200 dark:bg-orange-800/60 rounded px-0.5",children:d}),l]})}function js({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})})}function ws({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 15l7-7 7 7"})})}function Ns({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})}function Cs({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}function Is({filePath:t,chunkIndex:s,onClose:n,onNavigate:r}){const{chunks:a,isLoading:i,error:u}=Ce(t),d=Ss(t);return e.jsxs(R.div,{initial:{opacity:0,x:50},animate:{opacity:1,x:0},exit:{opacity:0,x:50},className:"h-full flex flex-col border-l",style:{background:"var(--ws-surface-raised)",borderColor:"var(--ws-border)"},children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b",style:{borderColor:"var(--ws-border)",background:"var(--ws-surface-1)"},children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"text-sm font-medium truncate",style:{color:"var(--ws-text)"},title:t,children:d}),e.jsxs("p",{className:"text-xs",style:{color:"var(--ws-text-muted)"},children:[a.length," chunks ¬∑ Viewing #",s]})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-4",children:[e.jsx("button",{type:"button",onClick:()=>r(t,s),className:"px-3 py-1.5 text-sm font-medium rounded-lg transition-colors",style:{color:"var(--ws-accent)"},children:"Open Full"}),e.jsx("button",{type:"button",onClick:n,className:"p-1.5 rounded-lg transition-colors",style:{color:"var(--ws-text-muted)"},"aria-label":"Close split view",children:e.jsx(Ls,{})})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:i?e.jsxs("div",{className:"flex items-center justify-center h-32",children:[e.jsx(q,{className:"w-6 h-6",style:{color:"var(--ws-text-muted)"}}),e.jsx("span",{className:"ml-2",style:{color:"var(--ws-text-muted)"},children:"Loading document..."})]}):u?e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-700 dark:text-red-400",children:[e.jsx("p",{className:"font-medium",children:"Error loading document"}),e.jsx("p",{className:"text-sm mt-1",children:u.message})]}):e.jsx(Te,{chunks:a,activeChunkIndex:s,onRegisterChunk:()=>{},scrollToChunk:s})})]})}function Ss(t){const s=t.split(/[/\\]/);return s[s.length-1]||t}function Ls(){return e.jsx("svg",{className:"h-5 w-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}function Ts({entries:t,activeChunkIndex:s,onNavigateToChunk:n,isOpen:r,onToggle:a,isFallback:i=!1}){const u=t.findIndex((l,x)=>{const c=t[x+1];return c?l.chunkIndex<=(s??0)&&c.chunkIndex>(s??0):l.chunkIndex<=(s??0)}),d=o.useCallback(l=>{n(l.chunkIndex)},[n]);return e.jsxs(e.Fragment,{children:[e.jsxs("button",{type:"button",onClick:a,className:"flex items-center gap-2 px-3 py-1.5 text-sm font-medium rounded-lg transition-colors",style:{color:"var(--ws-text-secondary)"},title:r?"Hide table of contents":"Show table of contents",children:[e.jsx(Ms,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Contents"}),e.jsx(R.span,{animate:{rotate:r?180:0},transition:{duration:.2},children:e.jsx(Rs,{className:"w-3 h-3"})})]}),e.jsx(A,{children:r&&e.jsx(R.div,{initial:{width:0,opacity:0},animate:{width:240,opacity:1},exit:{width:0,opacity:0},transition:{duration:.2},className:"fixed left-0 top-16 bottom-0 z-40 border-r shadow-lg overflow-hidden",style:{background:"var(--ws-surface-raised)",borderColor:"var(--ws-border)"},children:e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b",style:{borderColor:"var(--ws-border)"},children:[e.jsx("h3",{className:"text-sm font-semibold",style:{color:"var(--ws-text)"},children:"Table of Contents"}),i&&e.jsx("span",{className:"text-xs",style:{color:"var(--ws-text-muted)"},children:"(auto)"})]}),e.jsx("div",{className:"flex-1 overflow-y-auto py-2",children:t.length===0?e.jsx("div",{className:"px-4 py-8 text-center",style:{color:"var(--ws-text-muted)"},children:e.jsx("p",{className:"text-sm",children:"No headings detected"})}):e.jsx("nav",{className:"space-y-0.5",children:t.map((l,x)=>e.jsx(Os,{entry:l,isCurrent:x===u,onClick:()=>d(l)},l.id))})})]})})})]})}function Os({entry:t,isCurrent:s,onClick:n}){const r=16+(t.level-1)*12;return e.jsxs("button",{type:"button",onClick:n,className:`
        w-full text-left px-4 py-1.5 text-sm transition-colors border-l-2
        ${s?"font-medium":"border-transparent"}
      `,style:s?{background:"var(--ws-accent-subtle)",color:"var(--ws-accent)",borderColor:"var(--ws-accent)",paddingLeft:r}:{color:"var(--ws-text-secondary)",paddingLeft:r},children:[e.jsx("span",{className:"line-clamp-2",children:t.text}),t.type==="allcaps"&&e.jsx("span",{className:"ml-1 text-xs",style:{color:"var(--ws-text-muted)"},children:t.chunkIndex})]})}function Ms({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 6h16M4 10h16M4 14h16M4 18h16"})})}function Rs({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})}function $s({filePath:t,initialChunkIndex:s,onNavigate:n,onGoHome:r,pinnedChunkKeys:a,onTogglePin:i,onSaveTrail:u}){const[d,l]=o.useState(null),[x,c]=o.useState(()=>{const j=ce(t);return[{filePath:t,chunkIndex:s,label:j}]}),[f,m]=o.useState(!1),[g,y]=o.useState(!1),[h,b]=o.useState(!1),[v,w]=o.useState(!1),[k,S]=o.useState(null),E=o.useRef(null),{settings:K,cssVariables:H}=we(),{pins:B,getBacklinks:W,getPinsFromChunk:T}=Ne(),{chunks:N,isLoading:D,error:p}=Ce(t),{visibleChunkIndices:O,registerChunk:F,activeChunkIndex:C}=ht("100px"),{relatedChunks:z,isLoading:U}=ft(t,O,300,5),{results:I,isSearching:$,searchedText:L}=Rt({selectionText:k,filePath:t,chunkIndex:C??0,enabled:!d});o.useEffect(()=>{const j=()=>{const V=window.getSelection();if(!V||V.isCollapsed||!V.rangeCount){S(null);return}const J=V.toString().trim();J.length>=10?S(J):S(null)};let M;const P=()=>{clearTimeout(M),M=setTimeout(j,150)};return document.addEventListener("selectionchange",P),()=>{document.removeEventListener("selectionchange",P),clearTimeout(M)}},[]);const{entries:_,isFallback:Re}=it({chunks:N}),ee=o.useCallback(j=>{const M=document.getElementById(`chunk-${j}`);M&&M.scrollIntoView({behavior:"smooth",block:"center"})},[]),{searchState:X,isSearchOpen:te,openSearch:$e,closeSearch:se,setQuery:De,toggleCaseSensitive:Ee,nextMatch:de,previousMatch:ue,goToMatch:Ae,getMatchesForChunk:Ke}=Ct({chunks:N,onNavigateToChunk:ee}),{restorePosition:xe,hasSavedPosition:Be}=yt({filePath:t,chunks:N,activeChunkIndex:C}),Pe=o.useMemo(()=>C!==null?{filePath:t,chunkIndex:C}:null,[t,C]),{highlights:ne,annotations:re,createHighlight:he,deleteHighlight:He,updateHighlightColor:Fe,addNote:fe,updateNote:me,deleteNote:We}=kt(Pe),ze=o.useCallback(j=>j===C?ne:[],[C,ne]),Ve=o.useCallback((j,M,P,V,J,tt)=>{j===C&&he(M,P,V,J,tt)},[C,he]),Ge=o.useCallback(j=>{},[]),Ue=o.useCallback((j,M)=>{const P=re.get(j);P?me(P.id,M):fe(j,M)},[re,me,fe]),pe=o.useRef(!1);o.useEffect(()=>{if(N.length>0&&!pe.current&&!s){pe.current=!0;const j=xe();j&&requestAnimationFrame(()=>{const M=document.getElementById(`chunk-${j.chunkIndex}`);M&&M.scrollIntoView({behavior:"auto",block:"start"})})}},[N,xe,s]);const G=o.useMemo(()=>{if(C===null)return[];const j=`${t}:${C}`;return z[j]||[]},[t,C,z]),ae=o.useCallback((j,M)=>{const P=G.find(V=>V.filePath===j&&V.chunkIndex===M);c(V=>[...V,{filePath:j,chunkIndex:M,label:ce(j),connectionReason:P?.connectionReason}]),n(j,M)},[G,n]),oe=o.useCallback((j,M)=>{l({filePath:j,chunkIndex:M})},[]),_e=o.useCallback(j=>{if(!j.filePath){r();return}const M=x.findIndex(P=>P.filePath===j.filePath&&P.chunkIndex===j.chunkIndex);M!==-1&&c(P=>P.slice(0,M+1)),n(j.filePath,j.chunkIndex)},[x,n,r]),Qe=h||te||g,Ze=o.useMemo(()=>C===null?[]:W({filePath:t,chunkIndex:C}),[t,C,W]),Xe=o.useMemo(()=>C===null?[]:T({filePath:t,chunkIndex:C}),[t,C,T]),Ye=o.useCallback(()=>{if(G.length>0&&i){const j=G[0];j&&i(j.filePath,j.chunkIndex)}},[G,i]),Je=o.useCallback(()=>{if(d)l(null);else if(G.length>0){const j=G[0];j&&oe(j.filePath,j.chunkIndex)}},[d,G,oe]),qe=o.useCallback(()=>{b(!1),se(),y(!1)},[se]);gt({totalChunks:N.length,activeChunkIndex:C,onNavigateToChunk:ee,onToggleSplit:Je,onPinTopSuggestion:Ye,onOpenSearch:$e,onOpenHelp:()=>b(!0),onCloseOverlay:qe,isOverlayOpen:Qe,enabled:!0,isSearchOpen:te,onNextSearchMatch:de,onPreviousSearchMatch:ue});const et=ce(t);return e.jsxs("div",{className:"h-full flex flex-col",style:H,children:[e.jsx(Et,{items:x,onNavigate:_e,onSaveTrail:u,canSaveTrail:x.length>1}),e.jsxs("div",{className:"flex-1 flex overflow-hidden",children:[f&&e.jsx("div",{className:"w-60 flex-shrink-0"}),e.jsxs("div",{className:`
          flex flex-col overflow-hidden transition-all duration-300
          ${d?"w-[40%]":"w-[60%]"}
        `,children:[e.jsxs("div",{className:"book-header flex items-center justify-between px-6 py-4",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(Ts,{entries:_,activeChunkIndex:C,onNavigateToChunk:ee,isOpen:f,onToggle:()=>m(!f),isFallback:Re}),e.jsxs("div",{children:[e.jsx("h2",{className:"book-title text-xl truncate",title:t,children:et}),e.jsxs("p",{className:"text-sm text-stone-500 dark:text-stone-400 font-serif",children:[N.length," passages",C!==null&&` ¬∑ ¬ß${C}`,Be&&!s&&e.jsx("span",{className:"ml-2 text-amber-600 dark:text-amber-500",children:"¬∑ Restored"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 relative",children:[e.jsx(xs,{isOpen:v,onToggle:()=>w(!v),filePath:t,activeChunkIndex:C,relatedChunks:G,pins:B,onNavigateToChunk:ae}),e.jsx("button",{type:"button",onClick:()=>b(!0),className:"p-2 rounded-lg transition-colors",style:{color:"var(--ws-text-muted)"},title:"Keyboard shortcuts (?)",children:e.jsx(Ds,{className:"w-4 h-4"})}),e.jsx(gs,{onClick:()=>y(!g)}),e.jsx(bs,{isOpen:g,onClose:()=>y(!1)})]})]}),e.jsx("div",{ref:E,className:"flex-1 overflow-y-auto px-8 py-6 book-reader",children:D?e.jsxs("div",{className:"flex items-center justify-center h-32",children:[e.jsx(q,{className:"w-6 h-6",style:{color:"var(--ws-text-muted)"}}),e.jsx("span",{className:"ml-2",style:{color:"var(--ws-text-muted)"},children:"Loading document..."})]}):p?e.jsxs("div",{className:"bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 text-red-700 dark:text-red-400",children:[e.jsx("p",{className:"font-medium",children:"Error loading document"}),e.jsx("p",{className:"text-sm mt-1",children:p.message})]}):e.jsx(Te,{chunks:N,activeChunkIndex:C,onRegisterChunk:F,scrollToChunk:s,showChunkNumbers:K.showChunkNumbers,getHighlightsForChunk:ze,onCreateHighlight:Ve,onHighlightClick:Ge,getSearchMatchesForChunk:Ke,currentSearchIndex:X.currentIndex})})]}),e.jsx(A,{mode:"wait",children:d?e.jsx("div",{className:"w-[60%] border-l",style:{borderColor:"var(--ws-border)"},children:e.jsx(Is,{filePath:d.filePath,chunkIndex:d.chunkIndex,onClose:()=>l(null),onNavigate:(j,M)=>{l(null),ae(j,M)}})},"split"):e.jsx("div",{className:"w-[40%] border-l",style:{borderColor:"var(--ws-border)",background:"var(--ws-surface-1)"},children:e.jsx(ns,{relatedChunks:G,isLoading:U,activeChunkIndex:C,currentFilePath:t,onNavigateToChunk:ae,onOpenSplit:oe,pinnedChunkKeys:a,onTogglePin:i,highlights:ne,annotations:re,onUpdateNote:Ue,onDeleteNote:We,onDeleteHighlight:He,onChangeHighlightColor:Fe,backlinks:Ze,outgoingLinks:Xe,autoSelectionResults:I,isAutoSearching:$,selectionText:L})},"margin")})]}),e.jsx(ms,{isOpen:h,onClose:()=>b(!1)}),e.jsx(ys,{isOpen:te,query:X.query,matches:X.matches,currentIndex:X.currentIndex,caseSensitive:X.caseSensitive,onQueryChange:De,onToggleCaseSensitive:Ee,onNextMatch:de,onPreviousMatch:ue,onGoToMatch:Ae,onClose:se})]})}function ce(t){const s=t.split(/[/\\]/);return s[s.length-1]||t}function Ds({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6m-6 4h6"})})}function Es({currentTrail:t,savedTrails:s,onSaveTrail:n,onLoadTrail:r,onDeleteTrail:a,onClearCurrentTrail:i,onNavigateToStep:u,isOpen:d,onClose:l,trailTree:x,currentNodeId:c,onSetCurrentNode:f}){const[m,g]=o.useState(!1),[y,h]=o.useState(""),[b,v]=o.useState("current"),w=()=>{y.trim()&&(n(y.trim()),h(""),g(!1))};return d?e.jsx(R.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onClick:l,children:e.jsxs(R.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"rounded-xl shadow-xl max-w-lg w-full mx-4 max-h-[80vh] flex flex-col",style:{background:"var(--ws-surface-raised)"},onClick:k=>k.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b",style:{borderColor:"var(--ws-border)"},children:[e.jsx("h2",{className:"text-lg font-semibold",style:{color:"var(--ws-text)"},children:"Trail Manager"}),e.jsx("button",{type:"button",onClick:l,className:"p-1 rounded transition-colors",style:{color:"var(--ws-text-muted)"},children:e.jsx(Bs,{})})]}),e.jsxs("div",{className:"flex border-b",style:{borderColor:"var(--ws-border)"},children:[e.jsxs("button",{type:"button",onClick:()=>v("current"),className:`flex-1 px-4 py-2 text-sm font-medium transition-colors ${b==="current"?"border-b-2":""}`,style:b==="current"?{color:"var(--ws-accent)",borderColor:"var(--ws-accent)"}:{color:"var(--ws-text-muted)"},children:["Current Trail",t&&e.jsx("span",{className:"ml-2 text-xs px-1.5 py-0.5 rounded",style:{background:"var(--ws-accent-subtle)",color:"var(--ws-accent)"},children:t.steps.length})]}),e.jsxs("button",{type:"button",onClick:()=>v("saved"),className:`flex-1 px-4 py-2 text-sm font-medium transition-colors ${b==="saved"?"border-b-2":""}`,style:b==="saved"?{color:"var(--ws-accent)",borderColor:"var(--ws-accent)"}:{color:"var(--ws-text-muted)"},children:["Saved Trails",s.length>0&&e.jsx("span",{className:"ml-2 text-xs px-1.5 py-0.5 rounded",style:{background:"var(--ws-surface-1)",color:"var(--ws-text-secondary)"},children:s.length})]})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:e.jsx(A,{mode:"wait",children:b==="current"?e.jsx(R.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},exit:{opacity:0,x:20},children:t?e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"space-y-2",children:x?e.jsx(Me,{node:x,depth:0,currentNodeId:c,onNavigate:k=>u(k.chunkKey.filePath,k.chunkKey.chunkIndex),onSetCurrent:k=>f?.(k)}):t.steps.map((k,S)=>e.jsx(As,{step:k,index:S,isLast:S===t.steps.length-1,onNavigate:()=>u(k.chunkKey.filePath,k.chunkKey.chunkIndex)},`${k.chunkKey.filePath}-${k.chunkKey.chunkIndex}-${S}`))}),e.jsxs("div",{className:"flex gap-2 pt-2 border-t",style:{borderColor:"var(--ws-border)"},children:[e.jsx("button",{type:"button",onClick:()=>g(!0),disabled:t.steps.length<2,className:"flex-1 px-3 py-2 text-sm font-medium rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition-colors",style:{background:"var(--ws-accent)",color:"white"},children:"Save Trail"}),e.jsx("button",{type:"button",onClick:i,className:"px-3 py-2 text-sm font-medium rounded-lg transition-colors",style:{color:"var(--ws-text-secondary)",background:"var(--ws-surface-1)"},children:"Clear"})]})]}):e.jsxs("div",{className:"text-center py-8",style:{color:"var(--ws-text-muted)"},children:[e.jsx(Ps,{}),e.jsx("p",{className:"mt-2",children:"No active trail"}),e.jsx("p",{className:"text-sm mt-1",children:"Navigate between documents to start recording"})]})},"current"):e.jsx(R.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},children:s.length>0?e.jsx("div",{className:"space-y-2",children:s.map(k=>e.jsx(Ks,{trail:k,onLoad:()=>{r(k.id),l()},onDelete:()=>a(k.id)},k.id))}):e.jsxs("div",{className:"text-center py-8",style:{color:"var(--ws-text-muted)"},children:[e.jsx(Hs,{}),e.jsx("p",{className:"mt-2",children:"No saved trails"}),e.jsx("p",{className:"text-sm mt-1",children:"Save your explorations to revisit later"})]})},"saved")})}),e.jsx(A,{children:m&&e.jsx(R.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-black/30 flex items-center justify-center rounded-xl",children:e.jsxs(R.div,{initial:{scale:.9},animate:{scale:1},exit:{scale:.9},className:"rounded-lg p-4 m-4 shadow-lg",style:{background:"var(--ws-surface-raised)"},children:[e.jsx("h3",{className:"text-sm font-medium mb-3",style:{color:"var(--ws-text)"},children:"Save Trail"}),e.jsx("input",{type:"text",value:y,onChange:k=>h(k.target.value),placeholder:"Enter trail name...",className:"w-full px-3 py-2 border rounded-lg placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500",style:{borderColor:"var(--ws-border)",background:"var(--ws-surface-raised)",color:"var(--ws-text)"},onKeyDown:k=>{k.key==="Enter"&&w(),k.key==="Escape"&&g(!1)}}),e.jsxs("div",{className:"flex gap-2 mt-3",children:[e.jsx("button",{type:"button",onClick:w,disabled:!y.trim(),className:"flex-1 px-3 py-1.5 text-sm font-medium rounded-lg disabled:opacity-50 transition-colors",style:{background:"var(--ws-accent)",color:"white"},children:"Save"}),e.jsx("button",{type:"button",onClick:()=>g(!1),className:"px-3 py-1.5 text-sm font-medium rounded-lg transition-colors",style:{color:"var(--ws-text-secondary)",background:"var(--ws-surface-1)"},children:"Cancel"})]})]})})})]})}):null}function As({step:t,index:s,isLast:n,onNavigate:r}){const a=Oe(t.chunkKey.filePath);return e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:"w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium",style:n?{background:"var(--ws-accent)",color:"white"}:{background:"var(--ws-surface-2)",color:"var(--ws-text-secondary)"},children:s+1}),!n&&e.jsx("div",{className:"w-0.5 h-4",style:{background:"var(--ws-surface-2)"}})]}),e.jsxs("button",{type:"button",onClick:r,className:"flex-1 text-left p-2 rounded-lg transition-colors",children:[e.jsx("div",{className:"text-sm font-medium truncate",style:{color:"var(--ws-text)"},children:a}),e.jsxs("div",{className:"text-xs",style:{color:"var(--ws-text-muted)"},children:["Chunk #",t.chunkKey.chunkIndex,t.connectionReason&&e.jsxs("span",{className:"ml-2 italic",children:['via "',t.connectionReason,'"']})]})]})]})}function Ks({trail:t,onLoad:s,onDelete:n}){const[r,a]=o.useState(!1);return e.jsx("div",{className:"border rounded-lg p-3",style:{borderColor:"var(--ws-border)"},children:e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"text-sm font-medium truncate",style:{color:"var(--ws-text)"},children:t.name}),e.jsxs("p",{className:"text-xs mt-0.5",style:{color:"var(--ws-text-muted)"},children:[t.steps.length," steps ¬∑ ",new Date(t.updatedAt).toLocaleDateString()]})]}),e.jsx("div",{className:"flex items-center gap-1",children:r?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:n,className:"px-2 py-1 text-xs font-medium text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/30 rounded hover:bg-red-100 dark:hover:bg-red-900/50 transition-colors",children:"Delete"}),e.jsx("button",{type:"button",onClick:()=>a(!1),className:"px-2 py-1 text-xs font-medium rounded transition-colors",style:{color:"var(--ws-text-secondary)",background:"var(--ws-surface-1)"},children:"Cancel"})]}):e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:s,className:"px-2 py-1 text-xs font-medium rounded transition-colors",style:{color:"var(--ws-accent)"},children:"Load"}),e.jsx("button",{type:"button",onClick:()=>a(!0),className:"px-2 py-1 text-xs font-medium rounded transition-colors",style:{color:"var(--ws-text-muted)"},children:"Delete"})]})})]})})}function Oe(t){const s=t.split(/[/\\]/);return s[s.length-1]||t}function Bs(){return e.jsx("svg",{className:"w-5 h-5",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}function Ps(){return e.jsx("svg",{className:"mx-auto h-10 w-10",style:{color:"var(--ws-text-muted)"},fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"})})}function Hs(){return e.jsx("svg",{className:"mx-auto h-10 w-10",style:{color:"var(--ws-text-muted)"},fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",strokeWidth:1.5,children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"})})}function Me({node:t,depth:s,currentNodeId:n,onNavigate:r,onSetCurrent:a}){const[i,u]=o.useState(!0),d=Oe(t.chunkKey.filePath),l=t.id===n,x=t.children.length>1;return e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[x?e.jsx("button",{type:"button",onClick:()=>u(!i),className:"mt-1 w-5 h-5 flex items-center justify-center",style:{color:"var(--ws-text-muted)"},children:i?e.jsx(Fs,{className:"w-4 h-4"}):e.jsx(Ws,{className:"w-4 h-4"})}):e.jsx("div",{className:"w-5"}),e.jsx("div",{className:"flex items-center justify-center min-w-[2rem] h-6 px-1.5 rounded text-xs font-medium",style:l?{background:"var(--ws-accent)",color:"white"}:{background:"var(--ws-surface-2)",color:"var(--ws-text-secondary)"},children:t.branchLabel||s+1}),e.jsxs("button",{type:"button",onClick:()=>{r(t),a(t.id)},className:"flex-1 text-left p-2 rounded-lg transition-colors",style:l?{background:"var(--ws-accent-subtle)",borderWidth:"1px",borderStyle:"solid",borderColor:"var(--ws-accent)"}:{},children:[e.jsx("div",{className:"text-sm font-medium truncate",style:{color:"var(--ws-text)"},children:d}),e.jsxs("div",{className:"text-xs",style:{color:"var(--ws-text-muted)"},children:["Chunk #",t.chunkKey.chunkIndex,t.connectionReason&&e.jsxs("span",{className:"ml-2 italic",children:['via "',t.connectionReason,'"']})]})]})]}),i&&t.children.length>0&&e.jsx("div",{className:"ml-6 mt-1 space-y-1 border-l-2 pl-2",style:{borderColor:"var(--ws-border)"},children:t.children.map(c=>e.jsx(Me,{node:c,depth:s+1,currentNodeId:n,onNavigate:r,onSetCurrent:a},c.id))})]})}function Fs({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M19 9l-7 7-7-7"})})}function Ws({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})}function zs(t){try{let s=t.replace(/-/g,"+").replace(/_/g,"/");const n=s.length%4;n>0&&(s+="=".repeat(4-n));const r=atob(s),a=JSON.parse(r);if(a.v!==1)return console.error("Unsupported trail version:",a.v),null;if(!a.vault||!Array.isArray(a.steps))return console.error("Invalid trail structure"),null;for(const i of a.steps)if(typeof i.p!="string"||typeof i.c!="number")return console.error("Invalid step structure: each step must have p (string) and c (number)"),null;return a}catch(s){return console.error("Failed to decode trail:",s),null}}function Vs(){const t=window.location.hash;return t.startsWith("#trail=")?t.slice(7):null}function Gs(t,s){const n=[],r=[];if(t.vault!==s.currentVaultId&&n.push(`This trail was created in a different vault (${t.vault}). Some steps may not be available.`),t.steps.length===0)return r.push("Trail has no steps"),{success:!1,warnings:n,errors:r};const i=[],u=[];for(const l of t.steps)if(!(!l.p||typeof l.c!="number")){if(s.checkFileExists&&!s.checkFileExists(l.p)){u.push(l.p);continue}i.push({chunkKey:{filePath:l.p,chunkIndex:l.c},visitedAt:new Date().toISOString()})}if(u.length>0){const l=[...new Set(u)];n.push(`${l.length} file(s) not found and will be skipped: ${l.slice(0,3).join(", ")}${l.length>3?"...":""}`)}return i.length===0?(r.push("No valid steps found in trail"),{success:!1,warnings:n,errors:r}):{success:!0,trail:{id:crypto.randomUUID(),name:"Imported Trail",createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),steps:i},warnings:n,errors:r}}function Js(){const[t]=ut(),s=xt(),[n,r]=o.useState(!1),[a,i]=o.useState(!1),[u,d]=o.useState(null),l=t.get("path"),x=t.get("chunk"),c=x?Number.parseInt(x,10):void 0,{pinnedChunkKeys:f,togglePin:m}=dt(),{currentTrail:g,savedTrails:y,addStep:h,saveTrail:b,loadTrail:v,deleteTrail:w,clearCurrentTrail:k}=bt();o.useEffect(()=>{const T=Vs();if(!T)return;const N=zs(T);if(!N)return;const D=Gs(N,{currentVaultId:"default"});d({decoded:N,validation:D}),i(!0),window.history.replaceState(null,"",window.location.pathname+window.location.search)},[]);const S=o.useCallback((T,N)=>{const D=new URLSearchParams({path:T});N!==void 0&&D.set("chunk",String(N)),s(`/read?${D.toString()}`),h({filePath:T,chunkIndex:N??0})},[s,h]),E=o.useCallback(()=>{s("/")},[s]),K=o.useCallback((T,N)=>{!l||c===void 0||m({filePath:l,chunkIndex:c},{filePath:T,chunkIndex:N},"","",void 0)},[l,c,m]),H=o.useCallback(()=>{r(!0)},[]),B=o.useCallback(()=>{if(!u?.validation.trail)return;const T=u.validation.trail;if(T.steps.length>0){const N=T.steps[0];if(N){for(const D of T.steps)h(D.chunkKey);s(`/read?path=${encodeURIComponent(N.chunkKey.filePath)}&chunk=${N.chunkKey.chunkIndex}`)}}i(!1),d(null)},[u,h,s]),W=o.useCallback(()=>{i(!1),d(null)},[]);return l?e.jsxs("div",{className:"h-[calc(100vh-4rem)]",children:[e.jsx($s,{filePath:l,initialChunkIndex:c,onNavigate:S,onGoHome:E,pinnedChunkKeys:f,onTogglePin:K,onSaveTrail:H}),e.jsx(Es,{currentTrail:g,savedTrails:y,onSaveTrail:b,onLoadTrail:T=>{const N=v(T);if(N&&N.steps.length>0){const D=N.steps[0];D&&S(D.chunkKey.filePath,D.chunkKey.chunkIndex)}},onDeleteTrail:w,onClearCurrentTrail:k,onNavigateToStep:S,isOpen:n,onClose:()=>r(!1)}),e.jsx(A,{children:a&&u&&e.jsx(R.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-black/50",onClick:W,children:e.jsxs(R.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"rounded-xl shadow-xl max-w-md w-full mx-4 p-6",style:{background:"var(--ws-surface-raised)"},onClick:T=>T.stopPropagation(),children:[e.jsxs("div",{className:"flex items-center gap-3 mb-4",children:[e.jsx("div",{className:"p-2 rounded-lg",style:{background:"var(--ws-accent-subtle)"},children:e.jsx("span",{style:{color:"var(--ws-accent)"},children:e.jsx(Us,{className:"w-5 h-5"})})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold",style:{color:"var(--ws-text)"},children:"Import Shared Trail"}),e.jsxs("p",{className:"text-sm",style:{color:"var(--ws-text-muted)"},children:[u.decoded.steps.length," steps"]})]})]}),u.validation.warnings.length>0&&e.jsx("div",{className:"mb-4 p-3 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg",children:e.jsx("p",{className:"text-sm text-yellow-700 dark:text-yellow-300",children:u.validation.warnings[0]})}),u.validation.errors.length>0&&e.jsx("div",{className:"mb-4 p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-700 rounded-lg",children:e.jsx("p",{className:"text-sm text-red-700 dark:text-red-300",children:u.validation.errors[0]})}),u.validation.success&&u.validation.trail&&e.jsxs("div",{className:"mb-4 max-h-48 overflow-y-auto",children:[e.jsx("p",{className:"text-xs font-medium mb-2",style:{color:"var(--ws-text-muted)"},children:"Trail steps:"}),e.jsxs("div",{className:"space-y-1",children:[u.validation.trail.steps.slice(0,5).map((T,N)=>e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsxs("span",{className:"w-4",style:{color:"var(--ws-text-muted)"},children:[N+1,"."]}),e.jsx("span",{className:"truncate",style:{color:"var(--ws-text-secondary)"},children:T.chunkKey.filePath.split("/").pop()}),e.jsxs("span",{className:"text-xs",style:{color:"var(--ws-text-muted)"},children:["#",T.chunkKey.chunkIndex]})]},`${T.chunkKey.filePath}::${T.chunkKey.chunkIndex}`)),u.validation.trail.steps.length>5&&e.jsxs("p",{className:"text-xs pl-6",style:{color:"var(--ws-text-muted)"},children:["+",u.validation.trail.steps.length-5," more steps"]})]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{type:"button",onClick:W,className:"px-4 py-2 text-sm rounded-lg transition-colors",style:{color:"var(--ws-text-secondary)",background:"var(--ws-surface-1)"},children:"Cancel"}),u.validation.success&&e.jsx("button",{type:"button",onClick:B,className:"px-4 py-2 text-sm rounded-lg transition-colors",style:{background:"var(--ws-accent)",color:"white"},children:"Import & Navigate"})]})]})})})]}):e.jsx("div",{className:"max-w-4xl mx-auto py-12",children:e.jsxs("div",{className:"bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-700 rounded-lg p-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-yellow-800 dark:text-yellow-200 mb-2",children:"No document selected"}),e.jsx("p",{className:"text-yellow-700 dark:text-yellow-300 mb-4",children:"Please select a document from the search results or files page to read."}),e.jsx("button",{type:"button",onClick:E,className:"px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors",children:"Go to Search"})]})})}function Us({className:t}){return e.jsx("svg",{className:t,fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"})})}export{Js as ReaderPage};
